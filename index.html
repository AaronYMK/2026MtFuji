<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>2026 東京河口湖</title>
    
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Shippori+Mincho:wght@400;600;800&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            /* 天空水藍色系 */
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-light: #64748b;
            --primary-blue: #0ea5e9; /* Sky Blue 500 */
            --light-blue: #e0f2fe;    /* Sky Blue 100 */
            --highlight-blue: #38bdf8;
            --accent-orange: #f97316;
            --line-color: #e2e8f0;
            --font-serif: 'Shippori Mincho', serif;
            --font-sans: 'Noto Sans TC', sans-serif;
            --font-num: 'Lato', sans-serif;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.03);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: var(--font-sans);
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding-bottom: 100px;
        }

        /* Modal (Point & Speak / Driver) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 2000; display: none;
            flex-direction: column; justify-content: center; align-items: center;
            padding: 30px; text-align: center; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .modal-overlay.active { display: flex; }
        @keyframes slideUp { from {transform: translateY(100%);} to {transform: translateY(0);} }
        .modal-tag {
            color: var(--primary-blue); border: 1px solid var(--primary-blue);
            padding: 4px 12px; border-radius: 50px; font-size: 0.75rem; margin-bottom: 25px; letter-spacing: 2px;
        }
        .modal-content-box { width: 100%; }
        .modal-jp {
            font-family: var(--font-serif); font-size: 3rem; font-weight: 800;
            line-height: 1.3; margin-bottom: 15px; color: #000;
            word-break: keep-all;
        }
        .modal-sub { font-size: 1.2rem; color: #94a3b8; margin-bottom: 50px; }
        .modal-close {
            position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%);
            background: #0f172a; color: #fff; border: none; padding: 15px 50px;
            border-radius: 50px; font-size: 1rem; cursor: pointer;
        }

        /* 頂部 Header */
        header {
            background: rgba(248, 250, 252, 0.95); backdrop-filter: blur(10px);
            padding: 15px 0 0 0; position: sticky; top: 0; z-index: 100; text-align: center;
        }
        .trip-tag {
            font-size: 0.6rem; letter-spacing: 2px; color: var(--primary-blue);
            font-weight: 700; text-transform: uppercase; display: block; margin-bottom: 5px;
        }
        .trip-title { font-family: var(--font-serif); font-size: 1.3rem; font-weight: 600; }
        .trip-badge { 
            background: var(--light-blue); color: var(--primary-blue); padding: 2px 6px;
            border-radius: 6px; font-size: 0.7rem; vertical-align: middle; margin-left: 5px;
        }

        /* 日期滾動條 (置頂) */
        .date-scroller {
            display: flex; overflow-x: auto; padding: 10px 20px 15px 20px; gap: 28px;
            scrollbar-width: none; background: rgba(248, 250, 252, 0.95);
            border-bottom: 1px solid var(--line-color);
        }
        .date-scroller::-webkit-scrollbar { display: none; }
        .date-item {
            display: flex; flex-direction: column; align-items: center; min-width: 45px;
            color: #94a3b8; cursor: pointer; transition: all 0.3s;
        }
        .date-item.active { color: var(--primary-blue); transform: scale(1.05); }
        .d-day { font-size: 0.7rem; font-weight: 700; margin-bottom: 4px; font-family: var(--font-num); text-transform: uppercase;}
        .d-date { font-family: var(--font-serif); font-size: 1.6rem; line-height: 1; }
        .date-item.active .d-date { font-weight: 700; }
        
        /* Hero */
        .hero-section { padding: 20px 20px 10px; }
        .hero-card {
            height: 160px; border-radius: var(--radius); overflow: hidden; position: relative;
            background-size: cover; background-position: center;
            display: flex; align-items: flex-end; box-shadow: var(--shadow);
        }
        .hero-overlay {
            width: 100%; padding: 20px; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            color: white;
        }
        .hero-badge {
            background: rgba(255,255,255,0.25); backdrop-filter: blur(4px);
            padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; display: inline-block; margin-bottom: 5px;
        }
        .hero-title { margin: 0; font-family: var(--font-serif); font-size: 1.4rem; }

        /* 天氣與住宿區塊 */
        .weather-container { padding: 0 20px; margin-bottom: 20px; }
        .weather-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 15px; }
        .weather-loc { font-family: var(--font-serif); font-size: 1.8rem; line-height: 1; color: var(--text-main); }
        .weather-sub { font-size: 0.8rem; color: var(--text-light); margin-top: 5px; }
        
        .weather-strip { display: flex; gap: 25px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
        .weather-strip::-webkit-scrollbar { display: none; }
        .w-col { text-align: center; min-width: 35px; }
        .w-time { font-size: 0.75rem; color: #94a3b8; margin-bottom: 8px; font-family: var(--font-num); }
        .w-icon { font-size: 1.2rem; color: var(--primary-blue); margin-bottom: 5px; }
        .w-temp { font-weight: 600; font-size: 0.9rem; font-family: var(--font-num); }

        /* 住宿資訊 (還原圖片: 放在天氣下方) */
        .hotel-bar {
            margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--line-color);
            display: flex; align-items: center;
        }
        .hotel-line { width: 3px; height: 30px; background: #fca5a5; margin-right: 12px; border-radius: 2px; } /* 微粉色點綴 */
        .hotel-label { font-size: 0.65rem; color: #94a3b8; display: block; margin-bottom: 2px; }
        .hotel-name { font-family: var(--font-serif); font-size: 1.1rem; color: var(--text-main); font-weight: 600; }

        /* 分支切換 (Day 3) */
        .branch-toggle {
            margin: 10px 20px 20px; background: #f1f5f9; padding: 4px; border-radius: 10px; display: flex;
        }
        .branch-btn {
            flex: 1; border: none; background: none; padding: 8px; border-radius: 8px;
            font-size: 0.9rem; color: #64748b; font-weight: 500; cursor: pointer; transition: 0.2s;
        }
        .branch-btn.active { background: white; color: var(--primary-blue); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* --- Timeline 核心樣式 (還原圖片) --- */
        .timeline-wrapper { padding: 10px 20px; position: relative; }
        
        .timeline-row { display: flex; position: relative; padding-bottom: 30px; }
        
        /* 左側時間 */
        .t-time-col { 
            width: 55px; text-align: right; padding-right: 15px; flex-shrink: 0;
            font-family: var(--font-num); font-size: 1rem; color: var(--text-main); font-weight: 600;
            padding-top: 2px;
        }
        
        /* 中間線條 */
        .t-line-col { width: 20px; position: relative; display: flex; flex-direction: column; align-items: center; flex-shrink: 0; }
        .t-line { width: 2px; background: var(--line-color); height: 100%; position: absolute; top: 10px; z-index: 1; }
        .t-dot { 
            width: 8px; height: 8px; background: #cbd5e1; border-radius: 50%; z-index: 2; 
            margin-top: 8px; box-shadow: 0 0 0 3px var(--bg-color); transition: 0.3s;
        }
        
        /* 亮燈狀態 (Current Active) */
        .timeline-row.active .t-time-col { color: var(--primary-blue); transform: scale(1.1); transition: 0.3s; }
        .timeline-row.active .t-dot { 
            background: var(--primary-blue); 
            box-shadow: 0 0 0 4px var(--light-blue);
            transform: scale(1.2);
        }
        .timeline-row.active .t-line { background: linear-gradient(to bottom, var(--primary-blue) 0%, var(--line-color) 100%); }

        /* 右側卡片 */
        .t-card-col { flex: 1; padding-left: 5px; }
        .t-card {
            background: var(--card-bg); border-radius: var(--radius); padding: 18px;
            box-shadow: var(--shadow); position: relative; border-left: 4px solid transparent;
        }
        .t-card.type-Transport { border-left-color: #64748b; }
        .t-card.type-Food { border-left-color: var(--accent-orange); }
        .t-card.type-Spot { border-left-color: var(--primary-blue); }
        
        .t-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 6px; line-height: 1.4; }
        .t-tag { 
            font-size: 0.6rem; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; 
            color: #64748b; text-transform: uppercase; margin-bottom: 5px; display: inline-block;
        }
        
        /* 智能導遊 */
        .smart-guide {
            margin-top: 12px; background: #f8fafc; border-radius: 8px; padding: 12px;
            border: 1px dashed #cbd5e1;
        }
        .guide-head { font-size: 0.75rem; color: var(--primary-blue); font-weight: 700; margin-bottom: 5px; }
        .guide-text { font-size: 0.85rem; color: #475569; line-height: 1.6; text-align: justify; }
        .must-eat-tags { margin-top: 8px; display: flex; gap: 5px; flex-wrap: wrap; }
        .me-tag { background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; }

        /* 按鈕區 */
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }
        .action-btn {
            background: #f1f5f9; border: none; padding: 10px; border-radius: 8px;
            font-size: 0.85rem; color: var(--text-main); cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 5px;
            text-decoration: none;
        }
        .action-btn.primary { background: var(--light-blue); color: var(--primary-blue); font-weight: 500; }

        /* 錢包頁 */
        .wallet-container { padding: 20px; }
        .balance-card { 
            background: white; border-radius: 16px; padding: 25px; text-align: center;
            box-shadow: var(--shadow); margin-bottom: 20px;
        }
        .input-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .input-std { 
            padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; 
            font-size: 1rem; background: #fff; outline: none; transition: 0.2s;
        }
        .input-std:focus { border-color: var(--primary-blue); }
        .btn-add { background: var(--text-main); color: white; border: none; padding: 0 15px; border-radius: 10px; font-size: 1.2rem; }
        
        .expense-list { margin-top: 20px; }
        .exp-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px 0; border-bottom: 1px dashed #e2e8f0; 
        }
        .exp-date { font-size: 0.75rem; color: var(--primary-blue); background: var(--light-blue); padding: 2px 6px; border-radius: 4px; margin-right: 8px; font-family: var(--font-num); }
        .exp-del { color: #ef4444; background: none; border: none; margin-left: 10px; font-size: 1rem; padding: 5px; }

        /* 資訊頁 */
        .info-block { background: white; border-radius: 12px; padding: 20px; box-shadow: var(--shadow); margin-bottom: 15px; }
        .info-title { font-weight: 700; color: var(--primary-blue); margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }

        /* 底部導航 */
        .bottom-nav {
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px);
            border-radius: 50px; padding: 10px 30px;
            display: flex; justify-content: space-between;
            box-shadow: 0 10px 25px -5px rgba(14, 165, 233, 0.2); z-index: 1000;
            border: 1px solid rgba(255,255,255,0.6);
        }
        .nav-icon { font-size: 1.3rem; color: #94a3b8; padding: 10px; cursor: pointer; transition: 0.3s; }
        .nav-icon.active { color: var(--primary-blue); transform: translateY(-2px); }

        /* Views */
        .view-section { display: none; animation: fadeIn 0.4s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }

    </style>
</head>
<body>

<div id="modalOverlay" class="modal-overlay">
    <div id="modalTag" class="modal-tag">TAG</div>
    <div class="modal-content-box">
        <div id="modalMain" class="modal-jp">Text</div>
        <div id="modalSub" class="modal-sub">Sub</div>
    </div>
    <button class="modal-close" onclick="closeModal()">關閉 Close</button>
</div>

<header>
    <span class="trip-tag">2026 Winter Mt.Fuji</span>
    <div class="trip-title">冬季。河口湖 <span class="trip-badge">JP</span></div>
</header>

<div id="view-trip" class="view-section active">
    
    <div class="date-scroller" id="dateScroller"></div>

    <div class="hero-section">
        <div class="hero-card" id="heroCard">
            <div class="hero-overlay">
                <span class="hero-badge" id="heroDay">DAY 1</span>
                <h2 class="hero-title" id="heroTitle">抵達。新宿</h2>
            </div>
        </div>
    </div>

    <div class="weather-container">
        <div class="weather-header">
            <div>
                <div class="weather-loc" id="wLoc">Tokyo</div>
                <div class="weather-sub">未來 24 小時預報</div>
            </div>
            <i class="fas fa-sun" style="font-size:1.8rem; color:var(--primary-blue)"></i>
        </div>
        <div class="weather-strip" id="weatherStrip"></div>
        
        <div class="hotel-bar">
            <div class="hotel-line"></div>
            <div>
                <span class="hotel-label">住宿資訊 Accommodation</span>
                <div class="hotel-name" id="hotelName">Yksi Stay Shinjuku</div>
            </div>
        </div>
    </div>

    <div class="branch-toggle" id="branchToggle" style="display:none;">
        <button class="branch-btn active" onclick="switchBranch('A')"><i class="fas fa-sun"></i> 晴天方案</button>
        <button class="branch-btn" onclick="switchBranch('B')"><i class="fas fa-snowflake"></i> 雪天備案</button>
    </div>

    <div class="timeline-wrapper" id="timelineList"></div>
</div>

<div id="view-wallet" class="view-section">
    <div class="wallet-container">
        <div class="balance-card" style="padding:15px; margin-bottom:15px;">
            <div style="font-size:0.9rem; color:var(--primary-blue); margin-bottom:10px; font-weight:700;">匯率計算 (0.22)</div>
            <div style="display:flex; gap:10px; align-items:center;">
                <input type="number" id="calcJpy" class="input-std" placeholder="JPY" oninput="calcRate('jpy')" style="flex:1; text-align:right;">
                <i class="fas fa-exchange-alt" style="color:#cbd5e1"></i>
                <input type="number" id="calcTwd" class="input-std" placeholder="TWD" oninput="calcRate('twd')" style="flex:1; text-align:right;">
            </div>
        </div>

        <div class="balance-card">
            <div style="color:#94a3b8; font-size:0.8rem; margin-bottom:5px;">總支出 Total (TWD)</div>
            <div style="font-size:2.5rem; font-family:var(--font-serif); color:var(--text-main); font-weight:700;" id="totalDisplay">$0</div>
            
            <div style="margin-top:20px;">
                <div class="input-row">
                    <input type="date" id="expDate" class="input-std" style="width:130px; font-size:0.9rem;">
                    <input type="text" id="expName" class="input-std" style="flex:1;" placeholder="項目">
                </div>
                <div class="input-row">
                    <input type="number" id="expCost" class="input-std" style="flex:1;" placeholder="日幣金額">
                    <button class="btn-add" onclick="addExpense()">+</button>
                </div>
            </div>

            <div class="expense-list" id="expenseList"></div>
            
            <button onclick="clearAllExpenses()" style="width:100%; border:none; background:none; color:#ef4444; margin-top:20px; font-size:0.9rem;">清除所有紀錄</button>
        </div>
    </div>
</div>

<div id="view-info" class="view-section">
    <div class="wallet-container">
        <div class="info-block">
            <div class="info-title"><i class="fas fa-plane-departure"></i> 航班資訊 Flight</div>
            <div style="display:flex; justify-content:space-between; margin-bottom:12px; border-bottom:1px dashed #e2e8f0; padding-bottom:12px;">
                <div>
                    <div style="font-weight:700;">CI 100 (去程)</div>
                    <div style="font-size:0.85rem; color:#64748b;">09:30 TPE ➝ 13:30 NRT</div>
                </div>
                <div style="color:var(--primary-blue); font-size:0.8rem; background:var(--light-blue); padding:4px 8px; border-radius:6px; height:fit-content;">已確認</div>
            </div>
            <div style="display:flex; justify-content:space-between;">
                <div>
                    <div style="font-weight:700;">CI 109 (回程)</div>
                    <div style="font-size:0.85rem; color:#64748b;">20:00 NRT ➝ 22:55 TPE</div>
                </div>
                <div style="color:var(--primary-blue); font-size:0.8rem; background:var(--light-blue); padding:4px 8px; border-radius:6px; height:fit-content;">已確認</div>
            </div>
        </div>

        <div class="info-block">
            <div class="info-title"><i class="fas fa-ticket-alt"></i> 預約代碼</div>
            <div style="margin-bottom:10px;">
                <div style="font-size:0.75rem; color:#94a3b8;">[ 交通 ] 中華航空</div>
                <div style="font-family:monospace; font-size:1.1rem; letter-spacing:1px;">5IPVMR</div>
            </div>
            <div style="margin-bottom:10px;">
                <div style="font-size:0.75rem; color:#94a3b8;">[ 交通 ] Budget</div>
                <div style="font-family:monospace; font-size:1.1rem; letter-spacing:1px;">RC-2026-888</div>
            </div>
            <div style="margin-bottom:10px;">
                <div style="font-size:0.75rem; color:#94a3b8;">[ 住宿 ] Day 1 (1/26)：Yksi Stay</div>
                <div style="font-family:monospace; font-size:1.1rem; letter-spacing:1px;">TF753023F3EFB</div>
            </div>    
        </div>

        <div class="info-block">
            <div class="info-title"><i class="fas fa-exclamation-circle"></i> 緊急聯絡</div>
            <div class="btn-grid">
                <a href="tel:110" class="action-btn"><i class="fas fa-user-shield"></i> 警察 110</a>
                <a href="tel:119" class="action-btn"><i class="fas fa-ambulance"></i> 救護 119</a>
            </div>
        </div>
    </div>
</div>

<nav class="bottom-nav">
    <i class="fas fa-map-marked-alt nav-icon active" onclick="switchView('trip', this)"></i>
    <i class="fas fa-wallet nav-icon" onclick="switchView('wallet', this)"></i>
    <i class="fas fa-info-circle nav-icon" onclick="switchView('info', this)"></i>
</nav>

<script>
    // --- Config & State ---
    const RATE = 0.22;
    let currentBranch = 'A'; 
    let currentDayIdx = 0;

    // --- Data ---
    const itineraryData = [
        {
            day: 1, date: "26", week: "MON", title: "抵達。新宿", 
            loc: "Shinjuku", hotel: "Yksi Stay Shinjuku",
            bg: "https://images.unsplash.com/photo-1540959733332-eab4deabeeaf?w=800",
            events: [
                { time: "09:30", type: "Transport", title: "TPE 桃園機場第二航廈", desc: "班次：中華航空 CI 100 / 飛行時間：0930 ～ 1330 (4hr)", icon: "fa-plane" },
                { time: "15:14", type: "Transport", title: "NEX 成田特快", desc: "成田機場 ➝ 新宿站", icon: "fa-train" },
                { 
                    time: "18:00", type: "Food", title: "牛かつもと村", desc: "炸牛排定食",
                    guide: "【排隊名店】這家炸牛排以「只有炸60秒」聞名，外酥內生。請將牛排放在眼前的石盤上炙燒，聽到「滋滋」聲約3秒翻面，搭配山葵與特製醬油，口感外酥內嫩，白飯還可以免費續加！",
                    mustEat: ["炸牛排定食", "山藥泥"],
                    pointSpeak: { jp: "牛かつ定食をください", sub: "請給我炸牛排定食" }
                },
                { time: "22:30", type: "Food", title: "一蘭拉麵", desc: "新宿中央東口店", pointSpeak: { jp: "ラーメン", sub: "拉麵" } }
            ]
        },
        {
            day: 2, date: "27", week: "TUE", title: "忍野八海 & 山中湖", 
            loc: "Kawaguchiko", hotel: "秀峰閣湖月",
            bg: "https://images.unsplash.com/photo-1490806843957-31f4c9a91c65?w=800",
            events: [
                { time: "09:45", type: "Transport", title: "Budget 租車", desc: "河口湖站前店", icon: "fa-car" },
                { 
                    time: "10:45", type: "Spot", title: "忍野八海", desc: "神之泉湧池", addressJP: "山梨県南都留郡忍野村忍草",
                    guide: "【世界遺產】忍野八海是富士山融雪經過80年過濾後的湧泉群。其中「湧池」最深最藍，清澈見底。推薦在池邊買現烤的「草餅」，裡面包著紅豆餡，熱熱吃超幸福。",
                    mustEat: ["草餅", "泉水豆腐"]
                },
                { time: "12:00", type: "Food", title: "こし路 (Koshiji)", desc: "在地人食堂", mustEat: ["牛肉燴飯"] }
            ]
        },
        {
            day: 3, date: "28", week: "WED", title: "河口湖", 
            loc: "Kawaguchiko", hotel: "秀峰閣湖月",
            bg: "https://images.unsplash.com/photo-1578271887552-5ac3a72752bc?w=800",
            hasBranch: true,
            eventsA: [
                { 
                    time: "10:45", type: "Food", title: "手打うどん 彩花", desc: "吉田烏龍麵",
                    guide: "【全日本最硬】吉田烏龍麵以「嚼勁」著稱。彩花的麵條非常扎實，湯頭是味噌與醬油混合。配料通常有馬肉和高麗菜，加一點桌上的特製辣醬更對味。",
                    mustEat: ["肉烏龍麵", "冷烏龍"],
                    pointSpeak: { jp: "肉うどん", sub: "肉烏龍麵" }
                },
                { time: "12:15", type: "Spot", title: "天上山公園纜車", desc: "兔子神社", addressJP: "天上山公園" },
                { 
                    time: "14:30", type: "Spot", title: "天空鳥居", desc: "河口湖遙拝所", addressJP: "河口浅間神社",
                    guide: "【IG打卡聖地】需爬一小段山路才能到達。這裡是拍攝「鳥居框住富士山」的絕佳地點。建議使用廣角鏡頭，由下往上仰拍，氣勢滿分。",
                }
            ],
            eventsB: [
                { time: "11:00", type: "Food", title: "不動茶屋", desc: "餺飥麵", guide: "雪天必吃！這是山梨縣的鄉土料理，南瓜湯頭濃郁甘甜。" },
                { time: "12:30", type: "Spot", title: "音樂盒之森美術館", desc: "室內避雪", addressJP: "河口湖音楽と森の美術館" }
            ]
        },
        {
            day: 4, date: "29", week: "THU", title: "下吉田 & 新宿", 
            loc: "Shimoyoshida", hotel: "The Knot Shinjuku",
            bg: "https://images.unsplash.com/photo-1570459027562-4a916cc6113f?w=800",
            events: [
                { 
                    time: "12:00", type: "Spot", title: "新倉山淺間公園", desc: "五重塔與富士山", addressJP: "新倉山浅間公園",
                    guide: "【明信片風景】這裡就是那張著名的「櫻花+五重塔+富士山」拍攝地。雖然要爬398階樓梯，但山頂的景色絕對值得！",
                },
                { 
                    time: "19:30", type: "Food", title: "焼肉うしふじ", desc: "A5和牛燒肉",
                    guide: "【高級饗宴】行程最後一晚的犒賞。這家店提供A5等級的黑毛和牛，建議點「稀有部位拼盤」。裝潢時尚，是完美的Ending。",
                    mustEat: ["稀有部位拼盤", "生拌牛肉"],
                    pointSpeak: { jp: "本日の厳選和牛", sub: "今日嚴選和牛" }
                }
            ]
        },
        {
            day: 5, date: "30", week: "FRI", title: "新宿。回家", 
            loc: "Shinjuku", hotel: "溫暖的家",
            bg: "https://images.unsplash.com/photo-1542051841857-5f90071e7989?w=800",
            events: [
                { time: "08:45", type: "Food", title: "らぁ麺や 嶋", desc: "超人氣拉麵", addressJP: "東京都渋谷区西原3-7-1" },
                { time: "15:08", type: "Transport", title: "NEX 37號", desc: "前往成田機場", icon: "fa-train" },
                { time: "19:30", type: "Transport", title: "CI 109 回程", desc: "NRT ➝ TPE", icon: "fa-plane" }
            ]
        }
    ];

    // --- Init ---
    function init() {
        renderDateScroller();
        switchDay(0);
        
        // 設定預設日期為今天
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('expDate').value = today;
        
        loadExpenses();
    }

    // --- Logic ---
    function renderDateScroller() {
        const el = document.getElementById('dateScroller');
        el.innerHTML = itineraryData.map((d, i) => `
            <div class="date-item ${i===0?'active':''}" onclick="switchDay(${i})">
                <span class="d-day">${d.week}</span>
                <span class="d-date">${d.date}</span>
            </div>
        `).join('');
    }

    function switchDay(idx) {
        currentDayIdx = idx;
        const data = itineraryData[idx];
        
        // Update Dates
        document.querySelectorAll('.date-item').forEach((e, i) => e.classList.toggle('active', i===idx));

        // Update Hero
        document.getElementById('heroCard').style.backgroundImage = `url('${data.bg}')`;
        document.getElementById('heroDay').innerText = `DAY ${data.day}`;
        document.getElementById('heroTitle').innerText = data.title;
        document.getElementById('wLoc').innerText = data.loc;
        document.getElementById('hotelName').innerText = data.hotel;

        // Toggle Branch
        document.getElementById('branchToggle').style.display = data.hasBranch ? 'flex' : 'none';

        // Render Timeline
        renderTimeline(data);
        
        // Mock Weather
        renderWeather();
    }

    function switchBranch(type) {
        currentBranch = type;
        document.querySelectorAll('.branch-btn').forEach(b => b.classList.remove('active'));
        event.currentTarget.classList.add('active');
        switchDay(currentDayIdx);
    }

    function renderTimeline(data) {
        const container = document.getElementById('timelineList');
        let events = data.events;
        if(data.hasBranch) events = currentBranch === 'A' ? data.eventsA : data.eventsB;

        // 模擬現在時間以觸發 Highlight (假設現在是 11:30)
        const mockNow = "11:30"; // 實際使用可改為 new Date() 邏輯
        
        container.innerHTML = events.map(evt => {
            // 判斷是否為「現在進行式」的簡單邏輯 (範例)
            // 這裡為了演示效果，假設第二天10:45的行程正在進行
            const isActive = (data.day === 2 && evt.time === "10:45") ? 'active' : '';

            let btns = '';
            btns += `<a href="https://www.google.com/maps/search/?api=1&query=${evt.title}" target="_blank" class="action-btn"><i class="fas fa-location-arrow"></i> 導航</a>`;
            if(evt.pointSpeak) btns += `<button onclick="openModal('POINT & SPEAK', '${evt.pointSpeak.jp}', '${evt.pointSpeak.sub}')" class="action-btn primary"><i class="fas fa-hand-point-up"></i> 給店員看</button>`;
            if(evt.addressJP) btns += `<button onclick="openModal('TO DRIVER', '${evt.addressJP}', '${evt.title}')" class="action-btn"><i class="fas fa-taxi"></i> 給司機看</button>`;

            // 智能導遊區塊
            let guideHTML = '';
            if(evt.guide) {
                const tags = evt.mustEat ? evt.mustEat.map(f => `<span class="me-tag">#${f}</span>`).join('') : '';
                guideHTML = `
                <div class="smart-guide">
                    <div class="guide-head"><i class="fas fa-robot"></i> 智能導遊 Smart Guide</div>
                    <div class="guide-text">${evt.guide}</div>
                    <div class="must-eat-tags">${tags}</div>
                </div>`;
            }

            return `
            <div class="timeline-row ${isActive}">
                <div class="t-time-col">${evt.time}</div>
                <div class="t-line-col">
                    <div class="t-dot"></div>
                    <div class="t-line"></div>
                </div>
                <div class="t-card-col">
                    <div class="t-card type-${evt.type}">
                        <span class="t-tag">${evt.type}</span>
                        <div class="t-title">${evt.title}</div>
                        <div style="font-size:0.9rem; color:#64748b;">${evt.desc || ''}</div>
                        ${guideHTML}
                        <div class="btn-grid">${btns}</div>
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    function renderWeather() {
        const el = document.getElementById('weatherStrip');
        let html = '';
        for(let i=0; i<8; i++) {
            let t = 9 + i*2;
            html += `
            <div class="w-col">
                <div class="w-time">${t}:00</div>
                <div class="w-icon"><i class="fas fa-sun"></i></div>
                <div class="w-temp">${10 + Math.floor(Math.random()*5)}°</div>
            </div>`;
        }
        el.innerHTML = html;
    }

    // --- Modal ---
    function openModal(tag, main, sub) {
        document.getElementById('modalTag').innerText = tag;
        document.getElementById('modalMain').innerText = main;
        document.getElementById('modalSub').innerText = sub;
        document.getElementById('modalOverlay').classList.add('active');
    }
    function closeModal() {
        document.getElementById('modalOverlay').classList.remove('active');
    }

    // --- Wallet ---
    function calcRate(src) {
        const jpy = document.getElementById('calcJpy');
        const twd = document.getElementById('calcTwd');
        if(src==='jpy') twd.value = Math.round(jpy.value * RATE);
        else jpy.value = Math.round(twd.value / RATE);
    }

    function addExpense() {
        const date = document.getElementById('expDate').value;
        const name = document.getElementById('expName').value;
        const cost = parseInt(document.getElementById('expCost').value);
        if(!date || !name || !cost) return alert("請填寫完整資訊");

        const data = JSON.parse(localStorage.getItem('tripExp2026') || '[]');
        data.push({ id: Date.now(), date: date.slice(5), name, cost });
        localStorage.setItem('tripExp2026', JSON.stringify(data));
        
        document.getElementById('expName').value = '';
        document.getElementById('expCost').value = '';
        loadExpenses();
    }

    function delExpense(id) {
        let data = JSON.parse(localStorage.getItem('tripExp2026') || '[]');
        data = data.filter(i => i.id !== id);
        localStorage.setItem('tripExp2026', JSON.stringify(data));
        loadExpenses();
    }

    function clearAllExpenses() {
        if(confirm("確定刪除全部紀錄？")) {
            localStorage.removeItem('tripExp2026');
            loadExpenses();
        }
    }

    function loadExpenses() {
        const data = JSON.parse(localStorage.getItem('tripExp2026') || '[]');
        const list = document.getElementById('expenseList');
        let total = 0;
        
        list.innerHTML = data.reverse().map(item => {
            total += item.cost;
            const twd = Math.round(item.cost * RATE);
            return `
            <div class="exp-item">
                <div style="flex:1">
                    <span class="exp-date">${item.date}</span>
                    <span style="font-size:0.95rem;">${item.name}</span>
                </div>
                <div style="text-align:right;">
                    <div style="font-weight:700;">¥${item.cost.toLocaleString()}</div>
                    <div style="font-size:0.75rem; color:#94a3b8;">$${twd.toLocaleString()}</div>
                </div>
                <button class="exp-del" onclick="delExpense(${item.id})"><i class="fas fa-times-circle"></i></button>
            </div>`;
        }).join('');

        document.getElementById('totalDisplay').innerText = "$" + Math.round(total * RATE).toLocaleString();
    }

    // --- View Switch ---
    function switchView(view, btn) {
        document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
        document.getElementById('view-' + view).classList.add('active');
        document.querySelectorAll('.nav-icon').forEach(e => e.classList.remove('active'));
        btn.classList.add('active');
        window.scrollTo(0,0);
    }

    init();
</script>
</body>
</html>
